---
title: "Case Study: Tabula Muris Heart Data"
output: rmarkdown::html_vignette
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>"
)
```

# Introduction


```{r setup}
library(scClassify)
library(scater)
library(ggplot2)
library(gridExtra)
```

This vignette demonstrates a case study of `scClassify`, using Tabula Muris data from Heart tissue. 


```{r}
Heart_10X <- readRDS("Heart_10X.rds")
Heart_FACS <- readRDS("Heart_FACS.rds")

Heart_10X
Heart_FACS
```


The original cell type annotations and compositions of the example datasets can be easily accessed as shown below.

```{r}
cat("Data from Tabula Muris Heart 10X data")
table(Heart_10X$cell_ontology_class)
cat("Data from Tabula Muris  10X data")
table(Heart_FACS$cell_ontology_class)
```


# Setting up the data

scClassify utilises *log-transformed* (size-factor normalized) matrices as input where each row is a gene and each column a cell for a reference dataset and a query dataset. We will use `normalize()` in package `scater` to compute the log-normalize expression values.

```{r}
Heart_10X <- scater::normalize(Heart_10X)
Heart_FACS <- scater::normalize(Heart_FACS)
```


```{r fig.height=8, fig.width=12}
set.seed(2019)
Heart_10X <- scater::runUMAP(Heart_10X)
Heart_FACS <- scater::runUMAP(Heart_FACS)
g_10X <- plotUMAP(Heart_10X, colour_by = "cell_ontology_class") +
  theme(aspect.ratio = 1, legend.position = "bottom") +
  labs(title = "Tabula Muris (10X)")
g_FACS <- plotUMAP(Heart_FACS, colour_by = "cell_ontology_class") +
  theme(aspect.ratio = 1, legend.position = "bottom") +
  labs(title = "Tabula Muris (FACS)")
grid.arrange(g_10X, g_FACS, ncol = 2)
```


# scClassify



## Non-ensemble scClassify

We first perform non-ensemble `scClassify` by using Xin et al. as our reference dataset and Wang et al. data as ur query data. We use `WKNN` as the KNN algorithm, `DE` (differential expression genes) as the gene selection method, and lastly `pearson` as the similarity calculation method.

```{r}
scClassify_res <- scClassify(exprsMat_train = logcounts(Heart_10X),
                             cellTypes_train = Heart_10X$cell_ontology_class,
                             exprsMat_test = list(FACS = logcounts(Heart_FACS)),
                             cellTypes_test = list(FACS = Heart_FACS$cell_ontology_class),
                             tree = "HOPACH",
                             algorithm = "WKNN",
                             selectFeatures = c("limma"),
                             similarity = c("pearson"),
                             returnList = FALSE,
                             verbose = FALSE)

```

We can check the cell type tree generated by the reference data:

```{r warning=FALSE}
scClassify_res$trainRes
plotCellTypeTree(scClassify_res$trainRes@cellTypeTree)
```

Noted that `scClassify_res$trainRes` is a `scClassifyTrainModel` class.


Check the prediction results.

```{r}
Heart_FACS$scClassify_predicted <- scClassify_res$testRes$FACS$pearson_WKNN_limma$predRes

intermediate_cells <- lapply(strsplit(Heart_FACS$scClassify_predicted, "_"), length) > 1

# renamed the intermediate cell labels to intermediate
Heart_FACS$scClassify_predicted2 <- ifelse(intermediate_cells, 
                                           "intermediate", Heart_FACS$scClassify_predicted)

table(Heart_FACS$scClassify_predicted2, Heart_FACS$cell_ontology_class)
```


```{r fig.height=8, fig.width=12}
g_FACS_scClassify <- plotUMAP(Heart_FACS, colour_by = "scClassify_predicted2") +
  theme(aspect.ratio = 1, legend.position = "bottom") +
  labs(title = "Tabula Muris (FACS, scClassify annotated)")
grid.arrange(g_FACS, g_FACS_scClassify, ncol = 2)
```





# Session Info

```{r}
sessionInfo()
```
